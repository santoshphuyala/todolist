<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List with Spending Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: gray;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #ffffff;
            --modal-text: #212529;
        }
        [data-theme="dark"] {
            --background-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: #495057;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: #adb5bd;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #343a40;
            --modal-text: #f8f9fa;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container, .list-group-item, .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
        }
        .completed { text-decoration: line-through; color: var(--completed-text); }
        .high { background-color: var(--high-bg); color: white; }
        .medium { background-color: var(--medium-bg); color: black; }
        .low { background-color: var(--low-bg); color: white; }
        .notes-collapse { max-height: 100px; overflow-y: auto; }
        .btn-primary, .btn-info, .btn-success, .btn-danger, .btn-warning, .btn-secondary {
            background-color: var(--button-bg);
            color: var(--button-text);
        }
        .theme-toggle-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .spending-entries-table {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="container py-5">
    <!-- Theme Toggle Button -->
    <button class="btn btn-secondary theme-toggle-btn" id="themeToggleBtn">Toggle Dark Mode</button>

    <h2 class="text-center mb-4">Todo List with Spending Tracker</h2>

    <!-- Category Filter Dropdown -->
    <div class="mb-3">
        <label for="categoryFilter" class="form-label">Filter by Category</label>
        <select id="categoryFilter" class="form-select" aria-label="Filter by category">
            <option value="all">All Categories</option>
            <option value="General">General</option>
            <option value="Work">Work</option>
            <option value="Personal">Personal</option>
        </select>
    </div>

    <!-- Task Input Form -->
    <div class="input-group mb-3">
        <input type="text" id="taskInput" class="form-control" placeholder="Add a new task" aria-label="Task description">
        <div class="invalid-feedback">Please enter a task description.</div>
        <select id="taskCategory" class="form-select" aria-label="Task category">
            <option value="General">General</option>
            <option value="Work">Work</option>
            <option value="Personal">Personal</option>
        </select>
        <select id="taskPriority" class="form-select" aria-label="Task priority">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
        </select>
        <select id="taskRecurrence" class="form-select" aria-label="Task recurrence">
            <option value="none">None</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
        </select>
        <input type="date" id="taskDate" class="form-control" aria-label="Due date">
        <div class="input-group mb-3">
            <textarea id="taskNotes" class="form-control" placeholder="Add notes (optional)" aria-label="Task notes" rows="2"></textarea>
        </div>
        <button class="btn btn-primary" id="addTaskBtn">Add Task</button>
        <button class="btn btn-secondary btn-sm" id="clearDateBtn">Clear Date</button>
    </div>

    <!-- Sort and Filter Buttons -->
    <div class="mb-3">
        <button class="btn btn-info" id="sortDateBtn">Sort by Date</button>
        <button class="btn btn-info" id="sortPriorityBtn">Sort by Priority</button>
        <button class="btn btn-info" id="filterPendingBtn">Show Pending</button>
        <button class="btn btn-info" id="filterCompletedBtn">Show Completed</button>
        <button class="btn btn-info" id="filterAllBtn">Show All</button>
    </div>

    <!-- Task List -->
    <ul id="taskList" class="list-group mb-3" role="list" aria-live="polite"></ul>

    <!-- Action Buttons -->
    <div>
        <button class="btn btn-info" id="exportExcelBtn">Export to Excel</button>
        <button class="btn btn-secondary" id="sendEmailBtn">Email Todo List</button>
        <button class="btn btn-success" id="markAllCompletedBtn">Mark All Completed</button>
        <button class="btn btn-danger" id="deleteAllBtn">Delete All</button>
        <button class="btn btn-warning" id="undoBtn">Undo</button>
        <button class="btn btn-warning" id="redoBtn">Redo</button>
        <button class="btn btn-primary" id="backupBtn">Backup Data</button>
        <button class="btn btn-primary" id="restoreBtn">Restore Data</button>
        <button class="btn btn-primary" id="spendingTrackerBtn">Spending Tracker</button>
        <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editTaskInput" class="form-label">Task Description</label>
                        <input type="text" id="editTaskInput" class="form-control" aria-label="Edit task description">
                        <div class="invalid-feedback">Task cannot be empty.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskCategory" class="form-label">Category</label>
                        <select id="editTaskCategory" class="form-select" aria-label="Edit task category">
                            <option value="General">General</option>
                            <option value="Work">Work</option>
                            <option value="Personal">Personal</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskPriority" class="form-label">Priority</label>
                        <select id="editTaskPriority" class="form-select" aria-label="Edit task priority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskRecurrence" class="form-label">Recurrence</label>
                        <select id="editTaskRecurrence" class="form-select" aria-label="Edit task recurrence">
                            <option value="none">None</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskDate" class="form-label">Due Date</label>
                        <div class="input-group">
                            <input type="date" id="editTaskDate" class="form-control" aria-label="Edit due date">
                            <button class="btn btn-secondary btn-sm" id="editClearDateBtn">Clear Date</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskNotes" class="form-label">Notes</label>
                        <textarea id="editTaskNotes" class="form-control" aria-label="Edit task notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">Send Todo List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="email" id="emailInput" class="form-control" placeholder="Enter recipient email" aria-label="Recipient email">
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendEmailConfirmBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spending Tracker Modal -->
    <div class="modal fade" id="spendingTrackerModal" tabindex="-1" aria-labelledby="spendingTrackerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingTrackerModalLabel">Spending Tracker</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="spendingAmount" class="form-label">Amount</label>
                        <input type="number" id="spendingAmount" class="form-control" placeholder="Enter amount" min="0" step="0.01" aria-label="Spending amount">
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="spendingType" class="form-label">Type</label>
                        <select id="spendingType" class="form-select" aria-label="Spending type">
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCategory" class="form-label">Category</label>
                        <select id="spendingCategory" class="form-select" aria-label="Spending category">
                            <option value="Food">Food</option>
                            <option value="Rent">Rent</option>
                            <option value="Salary">Salary</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingDate" class="form-label">Date</label>
                        <input type="date" id="spendingDate" class="form-control" aria-label="Spending date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSpendingBtn">Add Entry</button>
                    <button type="button" class="btn btn-info" id="viewSummaryBtn">View Summary</button>
                    <button type="button" class="btn btn-warning" id="manageEntriesBtn">Manage Entries</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spending Summary Modal -->
    <div class="modal fade" id="spendingSummaryModal" tabindex="-1" aria-labelledby="spendingSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingSummaryModalLabel">Spending Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Weekly Summary (Current Week, Monday to Sunday)</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Income</th>
                                <th>Expenses</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="weeklySummary"></tbody>
                    </table>
                    <h6>Monthly Summary</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummary"></tbody>
                    </table>
                    <h6>Yearly Summary</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="yearlySummary"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" id="exportSpendingExcelBtn">Export to Excel</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Spending Entries Modal -->
    <div class="modal fade" id="manageEntriesModal" tabindex="-1" aria-labelledby="manageEntriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageEntriesModalLabel">Manage Spending Entries</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="spending-entries-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spendingEntriesList"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Spending Entry Modal -->
    <div class="modal fade" id="editSpendingModal" tabindex="-1" aria-labelledby="editSpendingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSpendingModalLabel">Edit Spending Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSpendingAmount" class="form-label">Amount</label>
                        <input type="number" id="editSpendingAmount" class="form-control" placeholder="Enter amount" min="0" step="0.01" aria-label="Edit spending amount">
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingType" class="form-label">Type</label>
                        <select id="editSpendingType" class="form-select" aria-label="Edit spending type">
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCategory" class="form-label">Category</label>
                        <select id="editSpendingCategory" class="form-select" aria-label="Edit spending category">
                            <option value="Food">Food</option>
                            <option value="Rent">Rent</option>
                            <option value="Salary">Salary</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingDate" class="form-label">Date</label>
                        <input type="date" id="editSpendingDate" class="form-control" aria-label="Edit spending date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditSpendingBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.5.6/purify.min.js" integrity="sha512-WqUXS3XzR/4WNa4s+DjQd6zO7Wepg3jBqzCtoblzU2IAjdK9W8D7Y2AHb0Qz3JIuGL4cXWoS5T8q3IN0A9tkLTVQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
(function () {
    // State management
    const state = {
        tasks: [],
        history: [],
        redoStack: [],
        filter: 'all', // Status filter: all, pending, completed
        categoryFilter: 'all', // Category filter: all, General, Work, Personal
        spendingEntries: [] // Array to store spending entries
    };

    let loadTasksTimeout = null;
    let currentEditIndex = null;
    let currentEditSpendingIndex = null;
    const STORAGE_LIMIT = 5 * 1024 * 1024; // 5MB assumed localStorage limit
    const STORAGE_WARNING_THRESHOLD = 0.9; // Warn at 90% capacity

    // Utility: Debounce function
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Utility: Minify JSON for storage
    function minifyJSON(data) {
        return JSON.stringify(data);
    }

    // Utility: Parse minified JSON
    function parseMinifiedJSON(data) {
        return JSON.parse(data);
    }

    // Fallback sanitization if DOMPurify fails
    function sanitizeInput(input) {
        if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
            return DOMPurify.sanitize(input);
        }
        return input.replace(/<[^>]+>/g, '');
    }

    // Check localStorage capacity
    function checkStorageCapacity() {
        let total = 0;
        for (let x in localStorage) {
            if (localStorage.hasOwnProperty(x)) {
                total += ((localStorage[x].length + x.length) * 2);
            }
        }
        if (total > STORAGE_LIMIT * STORAGE_WARNING_THRESHOLD) {
            alert('Warning: Local storage is nearing capacity. Consider backing up and clearing tasks.');
        }
    }

    // Dark Mode Toggle
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        document.getElementById('themeToggleBtn').textContent = newTheme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
    }

    // Apply theme on load
    function applyTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggleBtn').textContent = savedTheme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
    }

    // Request notification permission
    function requestNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    } else {
                        console.log('Notification permission denied. Falling back to alerts.');
                    }
                }).catch(error => {
                    console.error('Error requesting notification permission:', error);
                });
            }
        } else {
            console.log('Browser does not support notifications. Falling back to alerts.');
        }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
        try {
            const storedTasks = localStorage.getItem("tasks");
            if (storedTasks) {
                state.tasks = parseMinifiedJSON(storedTasks);
            }
            const storedSpending = localStorage.getItem("spendingEntries");
            if (storedSpending) {
                state.spendingEntries = parseMinifiedJSON(storedSpending);
            }
        } catch (e) {
            console.error("Failed to load data:", e);
            alert("Unable to load data. Please check your browser settings.");
        }
        document.getElementById("taskDate").value = new Date().toISOString().split("T")[0];
        document.getElementById("spendingDate").value = new Date().toISOString().split("T")[0];
        applyTheme();
        initializeEventListeners();
        requestNotificationPermission();
        loadTasks();
        checkDueDates();
    });

    /**
     * Initializes all event listeners for buttons and inputs.
     */
    function initializeEventListeners() {
        document.getElementById("addTaskBtn").addEventListener("click", addTask);
        document.getElementById("clearDateBtn").addEventListener("click", clearDate);
        document.getElementById("sortDateBtn").addEventListener("click", () => sortTasks("date"));
        document.getElementById("sortPriorityBtn").addEventListener("click", () => sortTasks("priority"));
        document.getElementById("filterPendingBtn").addEventListener("click", () => filterTasks("pending"));
        document.getElementById("filterCompletedBtn").addEventListener("click", () => filterTasks("completed"));
        document.getElementById("filterAllBtn").addEventListener("click", () => filterTasks("all"));
        document.getElementById("categoryFilter").addEventListener("change", () => filterByCategory(document.getElementById("categoryFilter").value));
        document.getElementById("exportExcelBtn").addEventListener("click", exportToExcel);
        document.getElementById("sendEmailBtn").addEventListener("click", openEmailModal);
        document.getElementById("markAllCompletedBtn").addEventListener("click", markAllCompleted);
        document.getElementById("deleteAllBtn").addEventListener("click", deleteAllTasks);
        document.getElementById("undoBtn").addEventListener("click", undoAction);
        document.getElementById("redoBtn").addEventListener("click", redoAction);
        document.getElementById("saveEditBtn").addEventListener("click", saveEditedTask);
        document.getElementById("sendEmailConfirmBtn").addEventListener("click", sendEmail);
        document.getElementById("editClearDateBtn").addEventListener("click", () => document.getElementById("editTaskDate").value = "");
        document.getElementById("backupBtn").addEventListener("click", backupData);
        document.getElementById("restoreBtn").addEventListener("click", () => document.getElementById("restoreFileInput").click());
        document.getElementById("restoreFileInput").addEventListener("change", restoreData);
        document.getElementById("themeToggleBtn").addEventListener("click", toggleTheme);
        document.getElementById("spendingTrackerBtn").addEventListener("click", openSpendingTrackerModal);
        document.getElementById("addSpendingBtn").addEventListener("click", addSpendingEntry);
        document.getElementById("viewSummaryBtn").addEventListener("click", showSpendingSummary);
        document.getElementById("manageEntriesBtn").addEventListener("click", showManageEntries);
        document.getElementById("exportSpendingExcelBtn").addEventListener("click", exportSpendingToExcel);
        document.getElementById("saveEditSpendingBtn").addEventListener("click", saveEditedSpendingEntry);

        // Debounced input event for task input
        document.getElementById("taskInput").addEventListener("input", debounce(() => {
            document.getElementById("taskInput").classList.remove("is-invalid");
        }, 300));

        // Keyboard navigation for buttons
        document.querySelectorAll(".btn").forEach(btn => {
            btn.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    btn.click();
                    e.preventDefault();
                }
            });
        });
    }

    /**
     * Saves tasks to localStorage with compression.
     */
    function saveTasks() {
        try {
            checkStorageCapacity();
            localStorage.setItem("tasks", minifyJSON(state.tasks));
        } catch (e) {
            console.error("Failed to save tasks:", e);
            alert("Unable to save tasks. Please check your browser settings.");
            throw e;
        }
    }

    /**
     * Saves spending entries to localStorage.
     */
    function saveSpendingEntries() {
        try {
            checkStorageCapacity();
            localStorage.setItem("spendingEntries", minifyJSON(state.spendingEntries));
        } catch (e) {
            console.error("Failed to save spending entries:", e);
            alert("Unable to save spending entries. Please check your browser settings.");
            throw e;
        }
    }

    /**
     * Saves the current state to history for undo/redo.
     */
    function saveState() {
        state.history.push(minifyJSON(state.tasks));
        state.redoStack = [];
    }

    /**
     * Adds a new task to the list.
     */
    function addTask() {
        const taskInput = document.getElementById("taskInput");
        const taskText = taskInput.value.trim();
        const taskDate = document.getElementById("taskDate").value;
        const category = document.getElementById("taskCategory").value;
        const priority = document.getElementById("taskPriority").value;
        const recurrence = document.getElementById("taskRecurrence").value;
        const notes = document.getElementById("taskNotes").value.trim();

        if (!taskText) {
            taskInput.classList.add("is-invalid");
            return;
        }
        taskInput.classList.remove("is-invalid");

        try {
            saveState();
            state.tasks.push({
                text: sanitizeInput(taskText),
                date: taskDate || null,
                category,
                priority,
                recurrence,
                notes: sanitizeInput(notes),
                completed: false
            });
            saveTasks();
            resetInputs();
            loadTasks();
        } catch (e) {
            console.error("Failed to add task:", e);
            alert("Failed to add task. Please try again.");
        }
    }

    /**
     * Resets input fields to default values.
     */
    function resetInputs() {
        const taskInput = document.getElementById("taskInput");
        taskInput.value = "";
        taskInput.classList.remove("is-invalid");
        document.getElementById("taskCategory").value = "General";
        document.getElementById("taskPriority").value = "low";
        document.getElementById("taskRecurrence").value = "none";
        document.getElementById("taskDate").value = new Date().toISOString().split("T")[0];
        document.getElementById("taskNotes").value = "";
    }

    /**
     * Clears the due date input.
     */
    function clearDate() {
        document.getElementById("taskDate").value = "";
    }

    /**
     * Loads and displays tasks based on current filters.
     */
    function loadTasks() {
        if (loadTasksTimeout) cancelAnimationFrame(loadTasksTimeout);
        loadTasksTimeout = requestAnimationFrame(() => {
            const taskList = document.getElementById("taskList");
            taskList.innerHTML = "";
            let filteredTasks = state.tasks.filter(task => {
                const statusMatch = state.filter === "all" || (state.filter === "completed" ? task.completed : !task.completed);
                const categoryMatch = state.categoryFilter === "all" || task.category === state.categoryFilter;
                return statusMatch && categoryMatch;
            });

            filteredTasks.forEach((task, index) => {
                const taskItem = document.createElement("li");
                taskItem.className = `list-group-item d-flex flex-column ${task.priority} ${task.completed ? "completed" : ""}`;
                taskItem.setAttribute("role", "listitem");

                const taskInfo = document.createElement("div");
                taskInfo.className = "d-flex justify-content-between align-items-center";
                const taskText = document.createElement("span");
                taskText.textContent = `${task.text} - ${task.date || "No due date"} (${task.category}, ${task.priority}, ${task.recurrence})`;
                taskInfo.appendChild(taskText);

                const buttonGroup = document.createElement("div");
                const completeBtn = document.createElement("button");
                completeBtn.className = "btn btn-success btn-sm me-2";
                completeBtn.textContent = "âœ”";
                completeBtn.setAttribute("aria-label", "Mark completed");
                completeBtn.onclick = () => markCompleted(index);

                const editBtn = document.createElement("button");
                editBtn.className = "btn btn-warning btn-sm me-2";
                editBtn.textContent = "âœ";
                editBtn.setAttribute("aria-label", "Edit task");
                editBtn.onclick = () => editTask(index);

                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn btn-danger btn-sm";
                deleteBtn.textContent = "ðŸ—‘";
                deleteBtn.setAttribute("aria-label", "Delete task");
                deleteBtn.onclick = () => deleteTask(index);

                buttonGroup.append(completeBtn, editBtn, deleteBtn);
                taskInfo.appendChild(buttonGroup);

                // Notes section
                if (task.notes) {
                    const notesSection = document.createElement("div");
                    notesSection.className = "mt-2";
                    const notesToggle = document.createElement("button");
                    notesToggle.className = "btn btn-link btn-sm";
                    notesToggle.textContent = "Show Notes";
                    notesToggle.setAttribute("data-bs-toggle", "collapse");
                    notesToggle.setAttribute("data-bs-target", `#notes-${index}`);
                    const notesContent = document.createElement("div");
                    notesContent.id = `notes-${index}`;
                    notesContent.className = "collapse notes-collapse";
                    notesContent.textContent = task.notes;
                    notesSection.append(notesToggle, notesContent);
                    taskItem.append(taskInfo, notesSection);
                } else {
                    taskItem.appendChild(taskInfo);
                }

                taskList.appendChild(taskItem);
            });
        });
    }

    /**
     * Marks a task as completed or not.
     * @param {number} index - Index of the task.
     */
    function markCompleted(index) {
        try {
            saveState();
            state.tasks[index].completed = !state.tasks[index].completed;
            saveTasks();
            loadTasks();
        } catch (e) {
            console.error("Failed to mark task completed:", e);
            alert("Failed to update task. Please try again.");
        }
    }

    /**
     * Opens the edit task modal and populates fields.
     * @param {number} index - Index of the task.
     */
    function editTask(index) {
        currentEditIndex = index;
        const task = state.tasks[index];
        const editInput = document.getElementById("editTaskInput");
        editInput.value = task.text;
        editInput.classList.remove("is-invalid");
        document.getElementById("editTaskCategory").value = task.category;
        document.getElementById("editTaskPriority").value = task.priority;
        document.getElementById("editTaskRecurrence").value = task.recurrence;
        document.getElementById("editTaskDate").value = task.date || "";
        document.getElementById("editTaskNotes").value = task.notes || "";
        new bootstrap.Modal(document.getElementById("editTaskModal")).show();
    }

    /**
     * Saves the edited task with all fields.
     */
    function saveEditedTask() {
        const editInput = document.getElementById("editTaskInput");
        const newText = editInput.value.trim();
        const newCategory = document.getElementById("editTaskCategory").value;
        const newPriority = document.getElementById("editTaskPriority").value;
        const newRecurrence = document.getElementById("editTaskRecurrence").value;
        const newDate = document.getElementById("editTaskDate").value;
        const newNotes = document.getElementById("editTaskNotes").value.trim();

        if (!newText) {
            editInput.classList.add("is-invalid");
            return;
        }

        try {
            saveState();
            state.tasks[currentEditIndex] = {
                ...state.tasks[currentEditIndex],
                text: sanitizeInput(newText),
                category: newCategory,
                priority: newPriority,
                recurrence: newRecurrence,
                date: newDate || null,
                notes: sanitizeInput(newNotes)
            };
            saveTasks();
            loadTasks();
            bootstrap.Modal.getInstance(document.getElementById("editTaskModal")).hide();
        } catch (e) {
            console.error("Failed to save edited task:", e);
            editInput.classList.add("is-invalid");
            alert("Failed to save task. Please try again.");
        }
    }

    /**
     * Deletes a task.
     * @param {number} index - Index of the task.
     */
    function deleteTask(index) {
        try {
            saveState();
            state.tasks.splice(index, 1);
            saveTasks();
            loadTasks();
        } catch (e) {
            console.error("Failed to delete task:", e);
            alert("Failed to delete task. Please try again.");
        }
    }

    /**
     * Marks all tasks as completed.
     */
    function markAllCompleted() {
        try {
            saveState();
            state.tasks.forEach(task => task.completed = true);
            saveTasks();
            loadTasks();
        } catch (e) {
            console.error("Failed to mark all tasks completed:", e);
            alert("Failed to update tasks. Please try again.");
        }
    }

    /**
     * Deletes all tasks after confirmation.
     */
    function deleteAllTasks() {
        if (confirm("Are you sure you want to delete all tasks?")) {
            try {
                saveState();
                state.tasks = [];
                saveTasks();
                loadTasks();
            } catch (e) {
                console.error("Failed to delete all tasks:", e);
                alert("Failed to delete tasks. Please try again.");
            }
        }
    }

    /**
     * Undoes the last action.
     */
    function undoAction() {
        if (state.history.length > 0) {
            try {
                state.redoStack.push(minifyJSON(state.tasks));
                state.tasks = parseMinifiedJSON(state.history.pop());
                saveTasks();
                loadTasks();
            } catch (e) {
                console.error("Failed to undo action:", e);
                alert("Failed to undo. Please try again.");
            }
        } else {
            alert("No actions to undo.");
        }
    }

    /**
     * Redoes the last undone action.
     */
    function redoAction() {
        if (state.redoStack.length > 0) {
            try {
                state.history.push(minifyJSON(state.tasks));
                state.tasks = parseMinifiedJSON(state.redoStack.pop());
                saveTasks();
                loadTasks();
            } catch (e) {
                console.error("Failed to redo action:", e);
                alert("Failed to redo. Please try again.");
            }
        } else {
            alert("No actions to redo.");
        }
    }

    /**
     * Sorts tasks by date or priority.
     * @param {string} criteria - Sorting criteria ("date" or "priority").
     */
    function sortTasks(criteria) {
        try {
            document.querySelectorAll(".btn-info").forEach(btn => btn.classList.remove("active"));
            document.getElementById(`sort${criteria.charAt(0).toUpperCase() + criteria.slice(1)}Btn`).classList.add("active");
            saveState();
            state.tasks.sort((a, b) => {
                if (criteria === "date") {
                    const dateA = a.date ? new Date(a.date) : new Date("9999-12-31");
                    const dateB = b.date ? new Date(b.date) : new Date("9999-12-31");
                    return dateA - dateB;
                }
                if (criteria === "priority") {
                    const order = { high: 3, medium: 2, low: 1 };
                    return order[b.priority] - order[a.priority];
                }
            });
            saveTasks();
            loadTasks();
        } catch (e) {
            console.error("Failed to sort tasks:", e);
            alert("Failed to sort tasks. Please try again.");
        }
    }

    /**
     * Filters tasks by status (all, pending, completed).
     * @param {string} status - Filter status.
     */
    function filterTasks(status) {
        document.querySelectorAll(".btn-info").forEach(btn => btn.classList.remove("active"));
        document.getElementById(`filter${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).classList.add("active");
        state.filter = status;
        loadTasks();
    }

    /**
     * Filters tasks by category.
     * @param {string} category - Category to filter by.
     */
    function filterByCategory(category) {
        state.categoryFilter = category;
        loadTasks();
    }

    /**
     * Exports tasks to an Excel file.
     */
    function exportToExcel() {
        if (state.tasks.length === 0) {
            alert("No tasks to export.");
            return;
        }
        try {
            const worksheet = XLSX.utils.json_to_sheet(state.tasks.map(task => ({
                ...task,
                notes: task.notes || "None"
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Todo List");
            XLSX.writeFile(workbook, "Todo_List.xlsx");
        } catch (e) {
            console.error("Export failed:", e);
            alert("Failed to export tasks. Please try again.");
        }
    }

    /**
     * Opens the email modal.
     */
    function openEmailModal() {
        if (state.tasks.length === 0) {
            alert("No tasks to send.");
            return;
        }
        document.getElementById("emailInput").value = "";
        document.getElementById("emailInput").classList.remove("is-invalid");
        new bootstrap.Modal(document.getElementById("emailModal")).show();
    }

    /**
     * Sends the task list via email.
     */
    function sendEmail() {
        const emailInput = document.getElementById("emailInput");
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
        if (!emailRegex.test(email)) {
            emailInput.classList.add("is-invalid");
            return;
        }
        const taskListText = state.tasks.map(task =>
            `${task.text} - ${task.date || "No due date"} (${task.category}, ${task.priority}, ${task.recurrence}, ${task.completed ? "Completed" : "Pending"})\nNotes: ${task.notes || "None"}`
        ).join("\n\n");
        window.location.href = `mailto:${email}?subject=Todo List&body=${encodeURIComponent(taskListText)}`;
        bootstrap.Modal.getInstance(document.getElementById("emailModal")).hide();
    }

    /**
     * Checks for tasks due today and handles recurring tasks with browser notifications.
     */
    function checkDueDates() {
        const today = new Date().toISOString().split("T")[0];
        state.tasks.forEach((task, index) => {
            if (!task.completed && task.date === today) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Task Due Today', {
                        body: `Reminder: Task "${task.text}" is due today!`,
                        icon: 'https://via.placeholder.com/32'
                    });
                } else {
                    alert(`Reminder: Task "${task.text}" is due today!`);
                }
            }
            if (task.date && task.recurrence !== "none" && new Date(task.date) < new Date(today)) {
                const newDate = new Date(task.date);
                if (task.recurrence === "daily") {
                    newDate.setDate(newDate.getDate() + 1);
                } else if (task.recurrence === "weekly") {
                    newDate.setDate(newDate.getDate() + 7);
                } else if (task.recurrence === "monthly") {
                    newDate.setMonth(newDate.getMonth() + 1);
                }
                saveState();
                state.tasks.push({
                    ...task,
                    date: newDate.toISOString().split("T")[0],
                    completed: false
                });
                state.tasks[index].completed = true;
            }
        });
        saveTasks();
        loadTasks();
        setTimeout(checkDueDates, 5 * 60 * 1000);
    }

    /**
     * Backs up the current task list as a JSON file.
     */
    function backupData() {
        try {
            const data = JSON.stringify(state.tasks, null, 2);
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const date = new Date().toISOString().split("T")[0].replace(/-/g, "");
            a.href = url;
            a.download = `todo_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error("Failed to backup data:", e);
            alert("Failed to backup data. Please try again.");
        }
    }

    /**
     * Restores tasks from a JSON file, merging with existing tasks and removing duplicates.
     */
    function restoreData(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const restoredData = JSON.parse(e.target.result);
                if (!Array.isArray(restoredData)) {
                    throw new Error("Invalid backup format: must be an array.");
                }

                const sanitizedRestoredTasks = restoredData.map(task => ({
                    text: sanitizeInput(task.text || ""),
                    date: task.date && typeof task.date === "string" ? task.date : null,
                    category: ["General", "Work", "Personal"].includes(task.category) ? task.category : "General",
                    priority: ["low", "medium", "high"].includes(task.priority) ? task.priority : "low",
                    recurrence: ["none", "daily", "weekly", "monthly"].includes(task.recurrence) ? task.recurrence : "none",
                    notes: sanitizeInput(task.notes || ""),
                    completed: typeof task.completed === "boolean" ? task.completed : false
                })).filter(task => task.text.trim() !== "");

                if (sanitizedRestoredTasks.length === 0) {
                    throw new Error("No valid tasks found in backup.");
                }

                const taskMap = new Map();
                state.tasks.forEach(task => {
                    const key = JSON.stringify({
                        text: task.text,
                        date: task.date,
                        category: task.category,
                        priority: task.priority,
                        recurrence: task.recurrence,
                        notes: task.notes,
                        completed: task.completed
                    });
                    taskMap.set(key, task);
                });
                sanitizedRestoredTasks.forEach(task => {
                    const key = JSON.stringify({
                        text: task.text,
                        date: task.date,
                        category: task.category,
                        priority: task.priority,
                        recurrence: task.recurrence,
                        notes: task.notes,
                        completed: task.completed
                    });
                    if (!taskMap.has(key)) {
                        taskMap.set(key, task);
                    }
                });

                const mergedTasks = Array.from(taskMap.values());

                saveState();
                state.tasks = mergedTasks;
                state.history = [];
                state.redoStack = [];
                saveTasks();
                loadTasks();
                alert(`Data restored successfully! ${sanitizedRestoredTasks.length} tasks processed, ${mergedTasks.length - state.tasks.length} new tasks added.`);
            } catch (e) {
                console.error("Failed to restore data:", e);
                alert("Failed to restore data. Please ensure the file is a valid Todo List backup.");
            } finally {
                document.getElementById("restoreFileInput").value = "";
            }
        };
        reader.readAsText(file);
    }

    /**
     * Opens the spending tracker modal.
     */
    function openSpendingTrackerModal() {
        document.getElementById("spendingAmount").value = "";
        document.getElementById("spendingAmount").classList.remove("is-invalid");
        document.getElementById("spendingType").value = "Income";
        document.getElementById("spendingCategory").value = "Food";
        document.getElementById("spendingDate").value = new Date().toISOString().split("T")[0];
        new bootstrap.Modal(document.getElementById("spendingTrackerModal")).show();
    }

    /**
     * Adds a new spending entry.
     */
    function addSpendingEntry() {
        const amountInput = document.getElementById("spendingAmount");
        const amount = parseFloat(amountInput.value);
        const type = document.getElementById("spendingType").value;
        const category = document.getElementById("spendingCategory").value;
        const date = document.getElementById("spendingDate").value;

        if (isNaN(amount) || amount <= 0) {
            amountInput.classList.add("is-invalid");
            return;
        }
        amountInput.classList.remove("is-invalid");

        try {
            state.spendingEntries.push({
                amount,
                type,
                category,
                date
            });
            saveSpendingEntries();
            bootstrap.Modal.getInstance(document.getElementById("spendingTrackerModal")).hide();
            alert("Spending entry added successfully!");
        } catch (e) {
            console.error("Failed to add spending entry:", e);
            alert("Failed to add spending entry. Please try again.");
        }
    }

    /**
     * Shows the manage entries modal with a list of all spending entries.
     */
    function showManageEntries() {
        bootstrap.Modal.getInstance(document.getElementById("spendingTrackerModal")).hide();
        const entriesList = document.getElementById("spendingEntriesList");
        entriesList.innerHTML = "";

        if (state.spendingEntries.length === 0) {
            entriesList.innerHTML = "<tr><td colspan='5'>No spending entries found.</td></tr>";
        } else {
            state.spendingEntries.forEach((entry, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.type}</td>
                    <td>${entry.category}</td>
                    <td>$${entry.amount.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm me-2" onclick="editSpendingEntry(${index})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSpendingEntry(${index})">Delete</button>
                    </td>
                `;
                entriesList.appendChild(row);
            });
        }

        new bootstrap.Modal(document.getElementById("manageEntriesModal")).show();
    }

    /**
     * Opens the edit spending entry modal.
     * @param {number} index - Index of the spending entry.
     */
    window.editSpendingEntry = function(index) {
        currentEditSpendingIndex = index;
        const entry = state.spendingEntries[index];
        document.getElementById("editSpendingAmount").value = entry.amount;
        document.getElementById("editSpendingAmount").classList.remove("is-invalid");
        document.getElementById("editSpendingType").value = entry.type;
        document.getElementById("editSpendingCategory").value = entry.category;
        document.getElementById("editSpendingDate").value = entry.date;
        new bootstrap.Modal(document.getElementById("editSpendingModal")).show();
    };

    /**
     * Saves the edited spending entry.
     */
    function saveEditedSpendingEntry() {
        const amountInput = document.getElementById("editSpendingAmount");
        const amount = parseFloat(amountInput.value);
        const type = document.getElementById("editSpendingType").value;
        const category = document.getElementById("editSpendingCategory").value;
        const date = document.getElementById("editSpendingDate").value;

        if (isNaN(amount) || amount <= 0) {
            amountInput.classList.add("is-invalid");
            return;
        }
        amountInput.classList.remove("is-invalid");

        try {
            state.spendingEntries[currentEditSpendingIndex] = {
                amount,
                type,
                category,
                date
            };
            saveSpendingEntries();
            bootstrap.Modal.getInstance(document.getElementById("editSpendingModal")).hide();
            showManageEntries();
            alert("Spending entry updated successfully!");
        } catch (e) {
            console.error("Failed to update spending entry:", e);
            alert("Failed to update spending entry. Please try again.");
        }
    }

    /**
     * Deletes a spending entry.
     * @param {number} index - Index of the spending entry.
     */
    window.deleteSpendingEntry = function(index) {
        if (confirm("Are you sure you want to delete this spending entry?")) {
            try {
                state.spendingEntries.splice(index, 1);
                saveSpendingEntries();
                showManageEntries();
                alert("Spending entry deleted successfully!");
            } catch (e) {
                console.error("Failed to delete spending entry:", e);
                alert("Failed to delete spending entry. Please try again.");
            }
        }
    };

    /**
     * Exports spending entries to an Excel file.
     */
    function exportSpendingToExcel() {
        if (state.spendingEntries.length === 0) {
            alert("No spending entries to export.");
            return;
        }
        try {
            const worksheet = XLSX.utils.json_to_sheet(state.spendingEntries.map(entry => ({
                Date: entry.date,
                Type: entry.type,
                Category: entry.category,
                Amount: entry.amount
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Spending Entries");
            XLSX.writeFile(workbook, "Spending_Entries.xlsx");
        } catch (e) {
            console.error("Export failed:", e);
            alert("Failed to export spending entries. Please try again.");
        }
    }

    /**
     * Shows the spending summary modal with weekly, monthly, and yearly summaries.
     */
    function showSpendingSummary() {
        bootstrap.Modal.getInstance(document.getElementById("spendingTrackerModal")).hide();
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)); // Monday of the current week
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const yearStart = new Date(now.getFullYear(), 0, 1);

        // Weekly Summary by Day
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6); // Sunday
        const weeklySummaryTable = document.getElementById("weeklySummary");
        weeklySummaryTable.innerHTML = "";
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        for (let i = 0; i < 7; i++) {
            const currentDay = new Date(weekStart);
            currentDay.setDate(weekStart.getDate() + i);
            const dayString = currentDay.toISOString().split("T")[0];
            const dayEntries = state.spendingEntries.filter(entry => entry.date === dayString);
            const income = dayEntries
                .filter(entry => entry.type === "Income")
                .reduce((sum, entry) => sum + entry.amount, 0);
            const expenses = dayEntries
                .filter(entry => entry.type === "Expense")
                .reduce((sum, entry) => sum + entry.amount, 0);
            const balance = income - expenses;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${days[i]} (${dayString})</td>
                <td>$${income.toFixed(2)}</td>
                <td>$${expenses.toFixed(2)}</td>
                <td>$${balance.toFixed(2)}</td>
            `;
            weeklySummaryTable.appendChild(row);
        }

        // Monthly Summary
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const monthlyEntries = state.spendingEntries.filter(entry => {
            const entryDate = new Date(entry.date);
            return entryDate >= monthStart && entryDate <= monthEnd;
        });
        const monthlyIncome = monthlyEntries
            .filter(entry => entry.type === "Income")
            .reduce((sum, entry) => sum + entry.amount, 0);
        const monthlyExpenses = monthlyEntries
            .filter(entry => entry.type === "Expense")
            .reduce((sum, entry) => sum + entry.amount, 0);
        document.getElementById("monthlySummary").innerHTML = `
            <tr>
                <td>$${monthlyIncome.toFixed(2)}</td>
                <td>$${monthlyExpenses.toFixed(2)}</td>
                <td>$${(monthlyIncome - monthlyExpenses).toFixed(2)}</td>
            </tr>
        `;

        // Yearly Summary
        const yearEnd = new Date(now.getFullYear(), 11, 31);
        const yearlyEntries = state.spendingEntries.filter(entry => {
            const entryDate = new Date(entry.date);
            return entryDate >= yearStart && entryDate <= yearEnd;
        });
        const yearlyIncome = yearlyEntries
            .filter(entry => entry.type === "Income")
            .reduce((sum, entry) => sum + entry.amount, 0);
        const yearlyExpenses = yearlyEntries
            .filter(entry => entry.type === "Expense")
            .reduce((sum, entry) => sum + entry.amount, 0);
        document.getElementById("yearlySummary").innerHTML = `
            <tr>
                <td>$${yearlyIncome.toFixed(2)}</td>
                <td>$${yearlyExpenses.toFixed(2)}</td>
                <td>$${(yearlyIncome - yearlyExpenses).toFixed(2)}</td>
            </tr>
        `;

        new bootstrap.Modal(document.getElementById("spendingSummaryModal")).show();
    }
})();
    </script>
</body>
</html>